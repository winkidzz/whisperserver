# GitLab CI/CD Pipeline for WhisperCapRover Server
# Automatically deploys to CapRover when code is pushed to main branch 

stages:
  - test
  - deploy

variables:
  CAPROVER_URL: "https://captain.ishworks.website"
  CAPROVER_TOKEN: "718dbed697631ee134cfa77f2628917deaeeb72a750f063a1c08e145d29fb19d"
  APP_NAME: "whispercaprover"
  # Python caching optimization
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_CACHE_DIR: "false"

# Test stage - validate the code with optimized caching
test:
  stage: test
  image: python:3.9-slim
  tags:
    - shared
  before_script:
    # Install system dependencies for PyAudio and other audio libraries
    - apt-get update && apt-get install -y \
        portaudio19-dev \
        python3-dev \
        build-essential \
        libasound2-dev \
        libportaudio2 \
        libportaudiocpp0 \
        ffmpeg \
        && rm -rf /var/lib/apt/lists/*
    # Install Python packages with optimized caching
    - pip install --cache-dir $PIP_CACHE_DIR --upgrade pip
    - pip install --cache-dir $PIP_CACHE_DIR -r requirements.txt
  script:
    - python -c "import server; print('âœ… Server imports successfully')"
    - python -c "import fastapi; print('âœ… FastAPI available')"
    - python -c "import websockets; print('âœ… WebSockets available')"
    - python -c "import whisper; print('âœ… Whisper available')"
    - python -c "import pyaudio; print('âœ… PyAudio available')"
  # Optimized caching strategy
  cache:
    key: 
      files:
        - requirements.txt
    paths:
      - .pip-cache/
      - ~/.cache/pip/
    policy: pull-push
  artifacts:
    reports:
      junit: test-results.xml
    expire_in: 1 week
  only:
    - main
    - merge_requests

# Deploy to CapRover using GitLab's built-in integration
deploy:
  stage: deploy
  image: alpine:latest
  tags:
    - shared
  before_script:
    - apk add --no-cache curl
  script:
    # Deploy using CapRover API
    - |
      echo "ğŸš€ Deploying to CapRover..."
      response=$(curl -s -w "%{http_code}" -X POST \
        -H "X-Captain-Token: $CAPROVER_TOKEN" \
        -H "Content-Type: application/json" \
        -d '{
          "appName": "'$APP_NAME'",
          "gitHash": "'$CI_COMMIT_SHA'",
          "tarFile": null,
          "gitBranch": "main"
        }' \
        "$CAPROVER_URL/api/v2/user/apps/deployapp")
      
      http_code="${response: -3}"
      body="${response%???}"
      
      echo "Response: $body"
      echo "HTTP Code: $http_code"
      
      if [ "$http_code" = "200" ]; then
        echo "âœ… Deployment initiated successfully!"
      else
        echo "âŒ Deployment failed with HTTP code: $http_code"
        exit 1
      fi
    
    # Wait and check health
    - |
      echo "â³ Waiting for deployment to complete..."
      sleep 90
      
      echo "ğŸ¥ Performing health check..."
      if curl -f "$CAPROVER_URL/$APP_NAME/health" > /dev/null 2>&1; then
        echo "âœ… Health check passed! Deployment successful!"
        echo "ğŸŒ Your app is available at: $CAPROVER_URL/$APP_NAME"
      else
        echo "âŒ Health check failed"
        echo "ğŸ“‹ Check logs at: $CAPROVER_URL"
        exit 1
      fi
  only:
    - main
  environment:
    name: production
    url: https://captain.ishworks.website/whispercaprover
  when: manual
  allow_failure: false 